#!/bin/bash

if [[ ! "$_PYAV_ACTIVATED" ]]; then
    export here="$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)"
    source "$here/activate.sh"
fi

cd "$PYAV_ROOT"

# Always try to install the Python dependencies they are cheap.
pip install --upgrade -r tests/requirements.txt


# Skip the rest of the build if it already exists.
if [[ -e "$PYAV_LIBRARY_PREFIX/bin/ffmpeg" ]]; then
    echo "We have a cached build of $PYAV_LIBRARY; skipping re-build."
    exit 0
fi

# Update submodules
git submodule update --init --recursive

# Build nasm
cd $PYAV_ROOT/submodules/nasm
sh autogen.sh
./configure --prefix="$PYAV_ROOT/shared" --bindir="$PYAV_ROOT/bin"
make -j16 nasm ndisasm
# nasm makefile is dumb and tries to install .1 files that don't exist so just
# create them if they don't exist
touch nasm.1
touch ndisasm.1
make install nasm ndisasm

# Make sure the newly built nasm is on the path
PATH=$PYAV_ROOT/bin:$PATH

# Build x264
cd $PYAV_ROOT/submodules/x264
./configure --prefix="$PYAV_ROOT/shared" --bindir="$PYAV_ROOT/bin" --enable-pic --enable-static
make -j16
make install

# Nvidia build
CONFFLAGS_NVIDIA=""
if [[ -e /usr/local/cuda ]]; then
    # Get Nvidia headers for ffmpeg
    cd "$PYAV_ROOT/submodules/nv-codec-headers"
    make
    sudo make install
    PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH"
    CONFFLAGS_NVIDIA="--enable-cuda \
                      --enable-cuvid \
                      --enable-nvenc \
                      --enable-nonfree \
                      --enable-libnpp \
                      --extra-cflags=-I/usr/local/cuda/include \
                      --extra-ldflags=-L/usr/local/cuda/lib64"
else
    echo "WARNING: Did not find cuda libraries in /usr/local/cuda..."
    echo "         Building without hardware acceleration support"
fi

mkdir -p "$PYAV_LIBRARY_ROOT"
mkdir -p "$PYAV_LIBRARY_PREFIX"
cd "$PYAV_LIBRARY_ROOT"

# Download and expand the source.
if [[ ! -d $PYAV_LIBRARY ]]; then
    url="https://$PYAV_LIBRARY_NAME.org/releases/$PYAV_LIBRARY.tar.gz"
    echo Downloading $url
    wget --no-check-certificate "$url" || exit 1
    tar -xzf $PYAV_LIBRARY.tar.gz
    rm $PYAV_LIBRARY.tar.gz
    echo
fi
cd $PYAV_LIBRARY

echo ./configure
if [[ "$PYAV_LIBRARY_NAME" == ffmpeg ]]; then
    CONFFLAGS=--disable-stripping
fi
PKG_CONFIG_PATH="$PYAV_ROOT/shared/lib/pkgconfig:$PKG_CONFIG_PATH"
./configure \
    --enable-static \
    --enable-shared \
    --disable-doc \
    --enable-debug=3 \
    --enable-gpl \
    --enable-libx264 \
    --enable-gnutls \
    $CONFFLAGS_NVIDIA \
    $CONFFLAGS \
    --prefix="$PYAV_LIBRARY_PREFIX" \
    || exit 2
echo

echo make
make -j4 || exit 3
echo

echo make install
make install || exit 4
echo

echo Build products:
cd ~
find "$PYAV_LIBRARY_PREFIX" -name '*libav*'
